

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>social.instagram &mdash; cloudburst 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'0.1.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> cloudburst
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../social.html">Social</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vision.html">Vision</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cloudburst</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>social.instagram</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for social.instagram</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Scrape Instagram through its GraphQL API &quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">a2b_base64</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_letters</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">punctuation</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">cloudburst.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">concurrent</span><span class="p">,</span>
    <span class="n">write_dict_to_file</span><span class="p">,</span>
    <span class="n">get_dict_from_file</span><span class="p">,</span>
    <span class="n">mkdir</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cloudburst.vision</span> <span class="kn">import</span> <span class="n">download</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Instagram&quot;</span><span class="p">,</span> <span class="s2">&quot;download_instagram_by_shortcode&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="download_instagram_by_shortcode"><a class="viewcode-back" href="../../generated/social.download_instagram_by_shortcode.html#social.download_instagram_by_shortcode">[docs]</a><span class="k">def</span> <span class="nf">download_instagram_by_shortcode</span><span class="p">(</span><span class="n">shortcode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download a post from its shortcode</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shortcode : str</span>
<span class="sd">        shortcode from an Instagram post; see glossary for definition</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Download the Instagram post &quot;https://www.instagram.com/p/B-X0DDrj30s/&quot;</span>

<span class="sd">    &gt;&gt;&gt; from cloudburst import social as cbs</span>
<span class="sd">    &gt;&gt;&gt; cbs.download_instagram_by_shortcode(&quot;B-X0DDrj30s&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__download_media</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Download a post&#39;s media &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="c1"># Get content based on typename</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphImage&quot;</span><span class="p">:</span>
            <span class="n">content_url</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;display_resources&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
            <span class="c1"># Check to ensure content isn&#39;t gone from Facebook&#39;s CDN</span>
            <span class="k">if</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="s2">&quot;Gone&quot;</span><span class="p">:</span>
                <span class="n">download</span><span class="p">(</span><span class="n">content_url</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphVideo&quot;</span><span class="p">:</span>
            <span class="n">content_url</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;video_url&quot;</span><span class="p">]</span>
            <span class="c1"># Check to ensure content isn&#39;t gone from Facebook&#39;s CDN</span>
            <span class="k">if</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="s2">&quot;Gone&quot;</span><span class="p">:</span>
                <span class="n">download</span><span class="p">(</span><span class="n">content_url</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">download</span><span class="p">(</span><span class="n">content_url</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.mp4&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Full url with shortcode</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.instagram.com/p/</span><span class="si">{}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shortcode</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">?__a=1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s2">&quot;graphql&quot;</span><span class="p">][</span>
            <span class="s2">&quot;shortcode_media&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphSidecar&quot;</span><span class="p">:</span>
            <span class="c1"># Iterate through individual media in sidecar</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_sidecar_to_children&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
                <span class="n">__download_media</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">__download_media</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Print error if one occured along the way</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: could not download post </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span></div>


<div class="viewcode-block" id="Instagram"><a class="viewcode-back" href="../../generated/social.Instagram.html#social.Instagram">[docs]</a><span class="k">class</span> <span class="nc">Instagram</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Scrape the data of an Instagram User</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    username : str</span>
<span class="sd">        User&#39;s username</span>
<span class="sd">    id : str</span>
<span class="sd">        User&#39;s unique ID</span>
<span class="sd">    name : str</span>
<span class="sd">        User&#39;s full name</span>
<span class="sd">    biography : str</span>
<span class="sd">        User&#39;s biography</span>
<span class="sd">    url : str</span>
<span class="sd">        Linked site under user&#39;s biography</span>
<span class="sd">    followers : int</span>
<span class="sd">        Number of accounts following the user</span>
<span class="sd">    following : int</span>
<span class="sd">        Number of accounts user is following</span>
<span class="sd">    business_category_name : str</span>
<span class="sd">        Name of business category</span>
<span class="sd">    category_id : str</span>
<span class="sd">        ID of business category</span>
<span class="sd">    overall_category_name : str</span>
<span class="sd">        Name of overall category</span>
<span class="sd">    is_private : bool</span>
<span class="sd">        Is the account private</span>
<span class="sd">    is_verified : bool</span>
<span class="sd">        Is the account verified</span>
<span class="sd">    profile_pic_url_hd : str</span>
<span class="sd">        URL to high defintion profile picture</span>
<span class="sd">    connected_fb_page : str</span>
<span class="sd">        Connected Facebook page</span>
<span class="sd">    media_count : int</span>
<span class="sd">        Number of posts by user</span>
<span class="sd">    timestamp : int</span>
<span class="sd">        Current UNIX epoch timestamp</span>
<span class="sd">    shortcode_list : list</span>
<span class="sd">        List of all shortcodes for a user</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Contruct new object for @denimtears, gather media, do some analytics</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; from cloudburst import social as cbs</span>
<span class="sd">    &gt;&gt;&gt; ig = cbs.Instagram(&quot;denimtears&quot;) # Build pseudo-database for user</span>
<span class="sd">    &gt;&gt;&gt; ig.download_profile_picture()</span>
<span class="sd">    &gt;&gt;&gt; ig.get_previews()</span>
<span class="sd">    &gt;&gt;&gt; ig.download_stories()</span>
<span class="sd">    &gt;&gt;&gt; ig.download_highlights()</span>
<span class="sd">    &gt;&gt;&gt; ig.download_thumbnails()</span>
<span class="sd">    &gt;&gt;&gt; ig.download_posts()</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;First post: https://www.instagram.com/p/{ig.get_post_by_number(-1)}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(&quot;Querying for keyword \&quot;acyde\&quot;:&quot;)</span>
<span class="sd">    &gt;&gt;&gt; for shortcode, _ in ig.search_captions_by_keyword(&quot;acyde&quot;):</span>
<span class="sd">    &gt;&gt;&gt;     print(f&quot;\thttps://www.instagram.com/p/{shortcode}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Top tagged user: {ig.get_tagged_users()[0][0]}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Top tagged users in captions: {ig.get_tagged_users_in_captions()[0][0]}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Top hashtag: {ig.get_hashtags()[0][0]}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; top_liked_post = ig.get_posts_by_like_count()[0]</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Most liked post: https://www.instagram.com/p/{top_liked_post[0]} ({top_liked_post[1]} likes)&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Total lifetime likes: {ig.get_lifetime_like_count()}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Instagram.__init__"><a class="viewcode-back" href="../../generated/social.Instagram.html#social.Instagram.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            Any Instagram user&#39;s username to query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create ~/.cloudubrst directory if necessary</span>
        <span class="c1"># Used to store session</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;.cloudburst&quot;</span><span class="p">))</span>

        <span class="c1"># Login user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;.cloudburst/instagram_session.dat&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span> <span class="o">=</span> <span class="s2">&quot;Instagram 123.0.0.21.114 (iPhone; CPU iPhone OS 11_4 like Mac OS X; en_US; en-US; scale=2.00; 750x1334) AppleWebKit/605.1.15&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ig_pr&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__login</span><span class="p">()</span>

        <span class="c1"># Try to joad JSON file for user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">get_dict_from_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="c1"># Get current UNIX epoch timestamp for record keeping purposes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="c1"># If the file can&#39;t be found</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Retrieve JSON profile for user</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__a_query</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">login_required</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;graphql&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>

            <span class="c1"># Gather profile data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_url&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">following</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_follow&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">followers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_followed_by&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
                <span class="s2">&quot;d496eb541e5c789274548bf473cc553e&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,}</span>
            <span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;edge_owner_to_timeline_media&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profile_pic_url_hd&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verified</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overall_category_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;overall_category_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">business_category_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;business_category_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected_facebook</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;connected_fb_page&quot;</span><span class="p">]</span>

            <span class="c1"># Fill JSON file with profile data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;profile&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;biography&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">biography</span><span class="p">,</span>
                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="s2">&quot;following&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">following</span><span class="p">,</span>
                    <span class="s2">&quot;followers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span>
                    <span class="s2">&quot;media count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span><span class="p">,</span>
                    <span class="s2">&quot;profile pic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span><span class="p">,</span>
                    <span class="s2">&quot;private&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">,</span>
                    <span class="s2">&quot;verified&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verified</span><span class="p">,</span>
                    <span class="s2">&quot;business&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;overall category&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_category_name</span><span class="p">,</span>
                        <span class="s2">&quot;category name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">business_category_name</span><span class="p">,</span>
                        <span class="s2">&quot;category id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;facebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected_facebook</span><span class="p">,</span>
                    <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="s2">&quot;biography&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">biography</span><span class="p">,</span>
                            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                            <span class="s2">&quot;following&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">following</span><span class="p">,</span>
                            <span class="s2">&quot;followers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span>
                            <span class="s2">&quot;profile pic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span><span class="p">,</span>
                            <span class="s2">&quot;private&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">,</span>
                            <span class="s2">&quot;verified&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verified</span><span class="p">,</span>
                            <span class="s2">&quot;business&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;overall category&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_category_name</span><span class="p">,</span>
                                <span class="s2">&quot;category name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">business_category_name</span><span class="p">,</span>
                                <span class="s2">&quot;category id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="p">,</span>
                            <span class="p">},</span>
                            <span class="s2">&quot;facebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected_facebook</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;stories&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;highlights&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created at&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Get post shortcodes and fill posts with scaffold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shortcode_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_post_shortcodes</span><span class="p">()</span>
            <span class="c1"># No posts recorded for initial scaffold build</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorded_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__build_post_scaffold</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__populate_post_scaffold</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">story_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlight_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_stories</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_highlights</span><span class="p">()</span>
            <span class="c1"># Write JSON file to disk without spacing/indents</span>
            <span class="n">write_dict_to_file</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">minimize</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># If JSON file exists, read it into class attributes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Profile data gathered upon instantiation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;biography&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">following</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;following&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">followers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;followers&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;media count&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;profile pic&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;verified&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overall_category_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span>
                <span class="s2">&quot;overall category&quot;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">business_category_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span>
                <span class="s2">&quot;category name&quot;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span><span class="s2">&quot;category id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected_facebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;facebook&quot;</span><span class="p">]</span>

            <span class="c1"># Check for changes in profile, ignore unchangeable params</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">write_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__a_query</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">login_required</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;graphql&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;biography&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;biography&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_url&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_url&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_url&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">following</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_follow&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;following&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_follow&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;following&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_follow&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">followers</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_followed_by&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;followers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_followed_by&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;followers&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;edge_followed_by&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profile_pic_url_hd&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;profile_pic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profile_pic_url_hd&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;profile pic&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profile_pic_url_hd&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;private&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verified</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;verified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;verified&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">business_category_name</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;business_category_name&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span><span class="s2">&quot;category name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
                    <span class="s2">&quot;business_category_name&quot;</span>
                <span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;business category name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;business_category_name&quot;</span><span class="p">]}</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_id</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span><span class="s2">&quot;category id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;business category id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_category_name</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;overall_category_name&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;business&quot;</span><span class="p">][</span><span class="s2">&quot;overall category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
                    <span class="s2">&quot;overall_category_name&quot;</span>
                <span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;business overall category&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;overall_category_name&quot;</span><span class="p">]}</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected_facebook</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;connected_fb_page&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;facebook&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;connected_fb_page&quot;</span><span class="p">]</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;facebook&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;connected_fb_page&quot;</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No changes to profile detected&quot;</span><span class="p">)</span>
                <span class="n">write_changes</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If changes are detected, write them to JSON file</span>
            <span class="k">if</span> <span class="n">write_changes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span> <span class="n">changes</span><span class="p">})</span>
                <span class="n">write_dict_to_file</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">minimize</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="c1"># Check if number of recorded posts are equivalent to number of posted posts</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">])</span>
                <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
                    <span class="s2">&quot;d496eb541e5c789274548bf473cc553e&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,}</span>
                <span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;edge_owner_to_timeline_media&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># Currently recorded posts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recorded_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">]</span>
                <span class="c1"># Udpate shortcode list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shortcode_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_post_shortcodes</span><span class="p">()</span>
                <span class="c1"># Add shortcodes to json[&quot;posts&quot;] and write to disk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__build_post_scaffold</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shortcode_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__populate_post_scaffold</span><span class="p">()</span>
            <span class="c1"># Get story list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">story_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">story_id</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">story_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;stories&quot;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlight_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">highlight_id</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">highlight_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;highlights&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_stories</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_highlights</span><span class="p">()</span>
            <span class="n">write_dict_to_file</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">minimize</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache_session</span><span class="p">()</span></div>

    <span class="c1">########################</span>
    <span class="c1"># LOGIN/LOGOUT METHODS #</span>
    <span class="c1">########################</span>
    <span class="k">def</span> <span class="nf">__login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Log into Instagram &quot;&quot;&quot;</span>
        <span class="n">cached_session_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># Only load file if it was modified less than an hour ago</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># Load session from file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">cached_session_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session loaded from cache</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If no valid cache found, create new session</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cached_session_found</span><span class="p">:</span>
            <span class="c1"># Prompt user for login username and password</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">login_username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Username: &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">login_password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;Password: &quot;</span><span class="p">)</span>

            <span class="c1"># Attempt login</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.instagram.com/&quot;</span><span class="p">,</span> <span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;X-CSRFToken&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;https://www.instagram.com/&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s2">&quot;csrftoken&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;https://www.instagram.com/accounts/login/ajax/&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_password</span><span class="p">},</span>
                <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;X-CSRFToken&quot;</span><span class="p">:</span> <span class="n">login</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s2">&quot;csrftoken&quot;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">login</span><span class="o">.</span><span class="n">cookies</span>
            <span class="n">login_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">login</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># Check if login succeeded</span>
            <span class="k">if</span> <span class="n">login_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authenticated&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">login</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">})</span>
            <span class="c1"># Display errors if necessary</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;two_factor_required&quot;</span> <span class="ow">in</span> <span class="n">login_response</span><span class="p">:</span>
                    <span class="c1"># This needs to be done</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: two-factor authentication not yet implemented.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">in</span> <span class="n">login_response</span><span class="p">:</span>
                    <span class="n">error_type</span> <span class="o">=</span> <span class="n">login_response</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;rate_limit_error&quot;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error: login failed for user @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">login_username</span><span class="si">}</span><span class="s2"> because of rate limiting&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sleeping for 2 minutes and retrying&quot;</span><span class="p">)</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__login</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error: login failed for user @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">login_username</span><span class="si">}</span><span class="s2"> with error </span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: login failed for user @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">login_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting program&quot;</span><span class="p">)</span>
                <span class="n">quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Cache session so unnecessary logins avoided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cache_session</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Log out of Instagram &quot;&quot;&quot;</span>
        <span class="c1"># Only logout if logged in</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;https://www.instagram.com/accounts/logout/&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;csrfmiddlewaretoken&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s2">&quot;csrftoken&quot;</span><span class="p">]},</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: logout failed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__cache_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Cache session to prevent unnecessary logins &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session cache file updated&quot;</span><span class="p">)</span>

    <span class="c1">##################</span>
    <span class="c1"># STATIC METHODS #</span>
    <span class="c1">##################</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__download_tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method/workaround to allow for concurrent downloading of images </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tuple : tuple</span>
<span class="sd">            Tuple or url and filename to deconstruct</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check to ensure content isn&#39;t gone from Facebook&#39;s CDN</span>
        <span class="k">if</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="s2">&quot;Gone&quot;</span><span class="p">:</span>
            <span class="n">download</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__media_preview_to_image</span><span class="p">(</span><span class="n">media_preview</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transform a media_preview string into a PIL Image through Instagram&#39;s proprietary compression algorithm </span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        media_preview : string</span>
<span class="sd">            Instagram media preview string</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        image : Image</span>
<span class="sd">            Turn media preview string into PIL Image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base64 to bytes</span>
        <span class="n">preview_binary</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a2b_base64</span><span class="p">(</span><span class="n">media_preview</span><span class="p">)]</span>
        <span class="c1"># Common header to bytes</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">a2b_base64</span><span class="p">(</span>
                    <span class="s2">&quot;/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABsaGikdKUEmJkFCLy8vQkc/Pj4/R0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0cBHSkpNCY0PygoP0c/NT9HR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR//AABEIABQAKgMBIgACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AA==&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="mi">162</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">160</span><span class="p">]</span> <span class="o">=</span> <span class="n">preview_binary</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># Encode data to bytes from ISO-8859-1 codec</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">header</span> <span class="o">+</span> <span class="n">preview_binary</span><span class="p">[</span><span class="mi">3</span><span class="p">:]])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="s2">&quot;iso-8859-1&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Create PIL Image from data</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">image</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__strip_hashtag</span><span class="p">(</span><span class="n">hashtag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove extraneous octothorpes and other punctuation from hashtags </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hashtag : string</span>
<span class="sd">            Hashtag to strip</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hashtag : string</span>
<span class="sd">            Properly stripped hashtag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">hashtag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                <span class="n">hashtag</span> <span class="o">=</span> <span class="n">hashtag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">hashtag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">punctuation</span><span class="p">):</span>
                <span class="n">hashtag</span> <span class="o">=</span> <span class="n">hashtag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">hashtag</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__strip_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove extraneous octothorpes and other punctuation from hashtags </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : string</span>
<span class="sd">            Username to strip</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        username : string</span>
<span class="sd">            Properly stripped username</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">username</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;._&quot;</span><span class="p">):</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">username</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">######################################</span>
    <span class="c1"># METHODS FOR BUILDING JSON DATABASE #</span>
    <span class="c1">######################################</span>
    <span class="k">def</span> <span class="nf">__a_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">login_required</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run a query through Instagram&#39;s &quot;?__a=1&quot; initial page-loading method </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : dict</span>
<span class="sd">            JSON data from ?__a=1 query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_queries_allowed</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">def</span> <span class="nf">__execute_a_query</span><span class="p">(</span><span class="n">query_url</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load data from query, using either logged in, or publically accessible page</span>
                <span class="k">if</span> <span class="n">login_required</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># If unsuccessful, try again, up to max attempt number</span>
                <span class="n">query_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">query_count</span> <span class="o">&lt;=</span> <span class="n">max_queries_allowed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: couldn&#39;t retrieve data @ </span><span class="si">{</span><span class="n">query_url</span><span class="si">}</span><span class="s2">. Retrying.&quot;</span><span class="p">)</span>
                    <span class="n">__a_query</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: couldn&#39;t retrieve data @ </span><span class="si">{</span><span class="n">query_url</span><span class="si">}</span><span class="s2">. Passing.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Form query url and exexcute query</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.instagram.com/</span><span class="si">{}</span><span class="s2">/?__a=1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">__execute_a_query</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__graphql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run a query through Instagram&#39;s GraphQL infrastructure </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hash : string</span>
<span class="sd">            GraphQL hash for query</span>
<span class="sd">        variables : dict</span>
<span class="sd">            Dictionary of variables to include in query</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : dict</span>
<span class="sd">            JSON data from GraphQL query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Construct GraphQL query url from query has and variables to pass</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.instagram.com/graphql/query/?</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">urlencode</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;query_hash&quot;</span><span class="p">:</span> <span class="nb">hash</span><span class="p">,</span>
                    <span class="s2">&quot;variables&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Actually execute the query here, retry method</span>
        <span class="k">def</span> <span class="nf">_graphql_query</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ok&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sleep_time</span> <span class="o">+=</span> <span class="mi">60</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Instagram GraphQL query failed. Sleeping for </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds before retrying.&quot;</span>
                <span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                <span class="n">_graphql_query</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If successful, load data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_graphql_query</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># If unsuccessful, return None</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with query </span><span class="si">{</span><span class="n">query_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__get_post_shortcodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get shortcodes for all posts by a user</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        old_list : list</span>
<span class="sd">            An old list of shortcodes, so not as to re-run unnecessary tasks</span>
<span class="sd">        progress_bar : bool</span>
<span class="sd">            Display progress of shortcode retrieval</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        shortcode_list : list</span>
<span class="sd">            List of all shortcodes for a user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load previous list if applicable, otherwise initialize empty list</span>
        <span class="k">if</span> <span class="n">old_list</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shortcode_list</span> <span class="o">=</span> <span class="n">old_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shortcode_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ensure shortcodes can be downloaded</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
            <span class="n">end_cursor</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># Set current count to length of the shortcode list</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shortcode_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span><span class="p">:</span>
                <span class="c1"># Query GraphQL for Instagram shortcodes (max 50 at a time, can&#39;t parallelize)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
                    <span class="s2">&quot;d496eb541e5c789274548bf473cc553e&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="n">end_cursor</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                    <span class="c1"># Record end cursor for next query if necessary</span>
                    <span class="n">end_cursor</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;edge_owner_to_timeline_media&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;page_info&quot;</span><span class="p">][</span><span class="s2">&quot;end_cursor&quot;</span><span class="p">]</span>
                    <span class="c1"># Iterate through each post in the query</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;edge_owner_to_timeline_media&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
                        <span class="c1"># Grab shortcode, if not in list, add it to the list and increment count</span>
                        <span class="n">shortcode</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">shortcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shortcode_list</span><span class="p">:</span>
                            <span class="n">shortcode_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shortcode</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">progress_bar</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="s2">&quot; Retreived </span><span class="si">{}</span><span class="s2">% (</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">) of @</span><span class="si">{}</span><span class="s2">&#39;s posts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="nb">round</span><span class="p">(</span>
                                            <span class="mi">100</span>
                                            <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shortcode_list</span><span class="p">)</span>
                                            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span><span class="p">,</span>
                                            <span class="mi">2</span><span class="p">,</span>
                                        <span class="p">),</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">shortcode_list</span><span class="p">),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">media_count</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                    <span class="p">),</span>
                                    <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="p">)</span>
                        <span class="c1"># If the shortcode list is up to date, terminate the loop</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
        <span class="c1"># If user is private, print message and return empty list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shortcodes could not be accessed. User is private.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shortcode_list</span>

    <span class="k">def</span> <span class="nf">__build_post_scaffold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a basic post scaffold, adding each shortcode in a dict to json[&quot;posts], if not already existing &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">shortcode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortcode_list</span><span class="p">:</span>
            <span class="c1"># After confirming shortcode hasn&#39;t already been recorded, append it to dict</span>
            <span class="k">if</span> <span class="n">shortcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorded_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;shortcode&quot;</span><span class="p">:</span> <span class="n">shortcode</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__populate_post_scaffold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill JSON with user content&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__get_media</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Get various pieces of media-specific from a post &quot;&quot;&quot;</span>
            <span class="c1"># Media dict</span>
            <span class="n">media</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># ID</span>
            <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
            <span class="c1"># Media type</span>
            <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;typename&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]})</span>
            <span class="c1"># Media thumnail</span>
            <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;thumbnail&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;display_resources&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;src&quot;</span><span class="p">]})</span>
            <span class="c1"># Get content based on typename</span>
            <span class="k">if</span> <span class="n">media</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphImage&quot;</span><span class="p">:</span>
                <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">media</span><span class="p">[</span><span class="s2">&quot;thumbnail&quot;</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="n">media</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphVideo&quot;</span><span class="p">:</span>
                <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;video_url&quot;</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Media preview</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;media_preview&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;preview&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;media_preview&quot;</span><span class="p">]})</span>
            <span class="c1"># Tagged users in media media</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tagged_users</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tagged</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;edge_media_to_tagged_user&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">tagged</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span>
                    <span class="n">tagged_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">tagged_users</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">media</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tagged&quot;</span><span class="p">:</span> <span class="n">tagged_users</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> during __get_media&quot;</span><span class="p">)</span>

            <span class="c1"># Return built dict</span>
            <span class="k">return</span> <span class="n">media</span>

        <span class="k">def</span> <span class="nf">__build_post_from_scaffold</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Fill in post scaffold with available information &quot;&quot;&quot;</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="c1"># Execute only if post hasn&#39;t been recorded or if overwrite is True</span>
            <span class="k">if</span> <span class="s2">&quot;typename&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">post</span> <span class="ow">or</span> <span class="n">overwrite</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Get JSON data</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__a_query</span><span class="p">(</span>
                        <span class="s2">&quot;p/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shortcode</span><span class="p">),</span> <span class="n">login_required</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)[</span><span class="s2">&quot;graphql&quot;</span><span class="p">][</span><span class="s2">&quot;shortcode_media&quot;</span><span class="p">]</span>
                    <span class="c1"># Typename</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">typename</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;typename&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Media</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">media</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">typename</span> <span class="o">==</span> <span class="s2">&quot;GraphSidecar&quot;</span><span class="p">:</span>
                            <span class="c1"># Iterate through individual media in sidecar</span>
                            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;edge_sidecar_to_children&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
                                <span class="n">media</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__get_media</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">media</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__get_media</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;media&quot;</span><span class="p">:</span> <span class="n">media</span><span class="p">})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Caption</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;edge_media_to_caption&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">][</span>
                                    <span class="mi">0</span>
                                <span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Like count</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="s2">&quot;likes&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;edge_media_preview_like&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]}</span>
                        <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Comments count</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;edge_media_to_parent_comment&quot;</span><span class="p">][</span>
                                    <span class="s2">&quot;count&quot;</span>
                                <span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Dimensions</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Timestamp</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;taken_at_timestamp&quot;</span><span class="p">]})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Location</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Ad</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ad&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;is_ad&quot;</span><span class="p">]})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Accessibility caption</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;accessibility_caption&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;accessibility caption&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span>
                                        <span class="s2">&quot;accessibility_caption&quot;</span>
                                    <span class="p">]</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Write changes to JSON file</span>
                    <span class="n">write_dict_to_file</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">minimize</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Error gathering data for post https://www.instagram.com/p/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">shortcode</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Concurrently build post json from scaffold</span>
        <span class="n">concurrent</span><span class="p">(</span>
            <span class="n">__build_post_from_scaffold</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">],</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Building post database&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_story</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">story_item</span><span class="p">):</span>
        <span class="n">story</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Story type</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">story_typename</span> <span class="o">=</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;typename&quot;</span><span class="p">:</span> <span class="n">story_typename</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Story ID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Get content, if not video, default to thumbnail</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">story_typename</span> <span class="o">==</span> <span class="s2">&quot;GraphStoryVideo&quot;</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;video_resources&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;display_resources&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Media preview</span>
        <span class="k">if</span> <span class="s2">&quot;media_preview&quot;</span> <span class="ow">in</span> <span class="n">story_item</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;media_preview&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;preview&quot;</span><span class="p">:</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;media_preview&quot;</span><span class="p">]})</span>
        <span class="c1"># Timestamps</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;taken at&quot;</span><span class="p">:</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;taken_at_timestamp&quot;</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;expiring at&quot;</span><span class="p">:</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;expiring_at_timestamp&quot;</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Tappable objects</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">links</span> <span class="ow">in</span> <span class="n">story_item</span><span class="p">[</span><span class="s2">&quot;tappable_objects&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphTappableFeedMedia&quot;</span><span class="p">:</span>
                    <span class="n">story_shortcode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">][</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
                    <span class="n">linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://www.instagram.com/p/</span><span class="si">{</span><span class="n">story_shortcode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">links</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphTappableMention&quot;</span><span class="p">:</span>
                    <span class="n">story_username</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
                    <span class="n">linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://www.instagram.com/</span><span class="si">{</span><span class="n">story_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">story</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;linked&quot;</span><span class="p">:</span> <span class="n">linked</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">story</span>

    <span class="k">def</span> <span class="nf">__get_stories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
            <span class="s2">&quot;f5dc1457da7a4d3f88762dae127e0238&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;reel_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                <span class="s2">&quot;precomposed_overlay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;story_viewer_fetch_count&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># Try to add stories, pass if none</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">story_item</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;reels_media&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">]:</span>
                <span class="n">story</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_story</span><span class="p">(</span><span class="n">story_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">story</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_ids</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">story_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__get_highlight_reel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">highlight_reel_id</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
            <span class="s2">&quot;f5dc1457da7a4d3f88762dae127e0238&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;reel_ids&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;tag_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;location_ids&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;highlight_reel_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">highlight_reel_id</span><span class="p">)],</span>
                <span class="s2">&quot;precomposed_overlay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;show_story_viewer_list&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;story_viewer_fetch_count&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;story_viewer_cursor&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stories_video_dash_manifest&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;reels_media&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">highlight</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_story</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">content</span>

    <span class="k">def</span> <span class="nf">__get_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__graphql_query</span><span class="p">(</span>
            <span class="s2">&quot;ad99dd9d3646cc3c0dda65debcd266a7&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s2">&quot;include_reel&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;include_highlight_reels&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">reel</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;edge_highlight_reels&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">reel</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span>
            <span class="n">highlight_reel</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Reel name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">highlight_reel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">hr</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Reel ID</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">highlight_reel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">hr</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Reel cover media</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">highlight_reel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;cover&quot;</span><span class="p">:</span> <span class="n">highlight_reel</span><span class="p">[</span><span class="s2">&quot;cover_media&quot;</span><span class="p">][</span><span class="s2">&quot;thumbnail_src&quot;</span><span class="p">]}</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Reel content</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">highlight_reel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_highlight_reel</span><span class="p">(</span><span class="n">hr</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">highlight_reel</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlight_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;highlights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlight_reel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlight_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlight_reel</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="c1"># def get_following(self):</span>
    <span class="c1">#     self.__graphql_query(&quot;d04b0a864b4b54837c0d870b0e77e076&quot;, {&quot;id&quot;:str(self.id),&quot;first&quot;:50})</span>
    <span class="c1">#     self.__graphql_query(&quot;d04b0a864b4b54837c0d870b0e77e076&quot;, {&quot;id&quot;:str(self.id),&quot;first&quot;:50,&quot;after&quot;:end_cursor})</span>

    <span class="c1"># def get_followers(self):</span>
    <span class="c1">#     self.__graphql_query(&quot;c76146de99bb02f6415203be841dd25a&quot;, {&quot;id&quot;:str(self.id),&quot;first&quot;:50})</span>
    <span class="c1">#     self.__graphql_query(&quot;c76146de99bb02f6415203be841dd25a&quot;, {&quot;id&quot;:str(self.id),&quot;first&quot;:50,&quot;after&quot;:end_cursor})</span>

    <span class="c1"># def get_tagged_content(self):</span>
    <span class="c1">#     self.__graphql_query(&quot;ff260833edf142911047af6024eb634a&quot;, {&quot;id&quot;:str(self.id),&quot;first&quot;:50})</span>
    <span class="c1">#     # after</span>

    <span class="c1">#################################</span>
    <span class="c1"># METHODS FOR DOWNLOADING MEDIA #</span>
    <span class="c1">#################################</span>
    <span class="k">def</span> <span class="nf">download_profile_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Download an Instagram user&#39;s profile picure in its highest quality &quot;&quot;&quot;</span>
        <span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_pic</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_previews</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;previews&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all media previews for a user</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str</span>
<span class="sd">            Determine whether media preview images should be shown or saved</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : list</span>
<span class="sd">            List of all media previews as numpy arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make directory is necessary</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># Get media previews</span>
        <span class="n">previews</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;media&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Create filename</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_preview.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">output_dir</span><span class="p">,</span> <span class="n">shortcode</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="c1"># Append filename and media preview image</span>
                        <span class="n">previews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__media_preview_to_image</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;preview&quot;</span><span class="p">]))</span>
                        <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Shor or save image, depending on mode</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">previews</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;save&quot;</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;show&quot;</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: mode must be either save (default) or show&quot;</span><span class="p">)</span>

        <span class="c1"># Return media preview list</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">download_stories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Download all stories from an Instagram user in their highest quality</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir : str</span>
<span class="sd">            Path to directory where stories should be saved</span>
<span class="sd">        progress_bar : bool</span>
<span class="sd">            Display progress of post download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create output directory, if necessary</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Fill stories list with filenames and url&#39;s to hd thumbniails</span>
        <span class="n">stories_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;stories&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;mp4&quot;</span> <span class="k">if</span> <span class="n">story</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphStoryVideo&quot;</span> <span class="k">else</span> <span class="s2">&quot;jpg&quot;</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_story.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">ext</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">stories_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Concurently download images</span>
        <span class="n">concurrent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__download_tuple</span><span class="p">,</span>
            <span class="n">stories_list</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading stories&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Download all highlights from an Instagram user in their highest quality</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir : str</span>
<span class="sd">            Path to directory where highlights should be saved</span>
<span class="sd">        progress_bar : bool</span>
<span class="sd">            Display progress of post download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create output directory, if necessary</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Fill highlights list with filenames and url&#39;s to hd thumbniails</span>
        <span class="n">highlights_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">highlights</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;highlights&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">highlights</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">highlights</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;mp4&quot;</span> <span class="k">if</span> <span class="n">story</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphStoryVideo&quot;</span> <span class="k">else</span> <span class="s2">&quot;jpg&quot;</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_highlight.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">ext</span><span class="p">)</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">highlights_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Concurently download images</span>
        <span class="n">concurrent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__download_tuple</span><span class="p">,</span>
            <span class="n">highlights_list</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading highlights&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Download all posts from an Instagram user in their highest quality</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir : str</span>
<span class="sd">            Path to directory where thumbnails should be saved</span>
<span class="sd">        progress_bar : bool</span>
<span class="sd">            Display progress of post download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create output directory, if necessary</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Fill thumbnail list with filenames and url&#39;s to hd thumbniails</span>
        <span class="n">thumbnail_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;media&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">]:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_thumbnail.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">thumbnail_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;thumbnail&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Concurently download images</span>
        <span class="n">concurrent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__download_tuple</span><span class="p">,</span>
            <span class="n">thumbnail_list</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading thumbnails&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_posts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download all posts from an Instagram user in their highest quality</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir : str</span>
<span class="sd">            Path to directory where posts should be saved</span>
<span class="sd">        progress_bar : bool</span>
<span class="sd">            Display progress of post download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create output directory, if necessary</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Fill content list with filenames and url&#39;s to hd content</span>
        <span class="n">content_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">]:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;jpg&quot;</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GraphImage&quot;</span> <span class="k">else</span> <span class="s2">&quot;mp4&quot;</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">ext</span><span class="p">)</span>
                <span class="n">content_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>

        <span class="c1"># Concurently download images/videos</span>
        <span class="n">concurrent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__download_tuple</span><span class="p">,</span>
            <span class="n">content_list</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading posts&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">#####################################</span>
    <span class="c1"># METHODS FOR INFORMATION RETRIEVAL #</span>
    <span class="c1">#####################################</span>
    <span class="k">def</span> <span class="nf">get_post_by_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a post shortcode by number</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        number : str</span>
<span class="sd">            Number of post</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        shortcode : string</span>
<span class="sd">            Shortcode correlating with post</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure count is &lt;= media count</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;media count&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortcode_list</span><span class="p">[</span><span class="n">number</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Error: latest post is </span><span class="si">{}</span><span class="s2">, please enter number either lesser or equal to this post.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">count</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">search_captions_by_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find all captions containing a queried keyword</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keyword : str</span>
<span class="sd">            keyword to search captions for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        captions : list</span>
<span class="sd">            List of matches of form (shortcode, caption)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">captions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;caption&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">captions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]))</span>
        <span class="c1"># Return media preview list</span>
        <span class="k">return</span> <span class="n">captions</span>

    <span class="k">def</span> <span class="nf">get_tagged_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get list of all users tagged in post</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tagged_users : list</span>
<span class="sd">            List of all tagged users</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tagged_users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;media&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Get all tagged useres if existing</span>
                        <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;tagged&quot;</span><span class="p">]:</span>
                            <span class="n">username</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">tagged_users</span><span class="p">:</span>
                                <span class="n">tagged_users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shortcode</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tagged_users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">shortcode</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Return set of tagged users (remove duplicates)</span>
        <span class="n">tagged_users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">tagged_users</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tagged_users</span>

    <span class="k">def</span> <span class="nf">get_tagged_users_in_captions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get list of all users tagged in captions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tagged_users : list</span>
<span class="sd">            List of all tagged users in captions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tagged_users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;caption&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">:</span>
                        <span class="c1"># Ensure two hashtags not stuck together</span>
                        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
                            <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__strip_username</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">word</span> <span class="o">!=</span> <span class="s2">&quot;@&quot;</span> <span class="ow">and</span> <span class="n">word</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tagged_users</span><span class="p">:</span>
                                    <span class="n">tagged_users</span><span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shortcode</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tagged_users</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">shortcode</span><span class="p">]</span>
        <span class="c1"># Return sorted tagged users in captions</span>
        <span class="n">tagged_users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">tagged_users</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tagged_users</span>

    <span class="k">def</span> <span class="nf">get_hashtags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all hashtags (and the posts that use them) from a user, sorted by frequency </span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hashtags : list</span>
<span class="sd">            Sorted list of all hashtags by post frequency of form (hashtag, [shortcode(s)])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hashtags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;caption&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="c1"># Solve the #BEENTRILL# problem</span>
                    <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                        <span class="c1"># Ensure two hashtags not stuck together</span>
                        <span class="k">for</span> <span class="n">hashtag</span> <span class="ow">in</span> <span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                            <span class="n">hashtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__strip_hashtag</span><span class="p">(</span><span class="n">hashtag</span><span class="p">)</span>
                            <span class="c1"># print(hashtag)</span>
                            <span class="k">if</span> <span class="n">hashtag</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="n">hashtag</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hashtag</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">hashtag</span> <span class="ow">in</span> <span class="n">hashtags</span><span class="p">:</span>
                                    <span class="n">hashtags</span><span class="p">[</span><span class="n">hashtag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shortcode</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">hashtags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">hashtag</span><span class="p">:</span> <span class="p">[</span><span class="n">shortcode</span><span class="p">]})</span>

        <span class="c1"># Return hashtags list</span>
        <span class="n">hashtags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hashtags</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashtags</span>

    <span class="k">def</span> <span class="nf">get_posts_by_like_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sort posts by like count</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        likes : list</span>
<span class="sd">            Sorted list of all posts by like count in form (shortcode, like count)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">likes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;posts&quot;</span><span class="p">]:</span>
            <span class="n">shortcode</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;shortcode&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;likes&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
                <span class="n">likes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;likes&quot;</span><span class="p">]))</span>
        <span class="c1"># Sort like list and return</span>
        <span class="n">likes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">likes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">likes</span>

    <span class="k">def</span> <span class="nf">get_lifetime_like_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Total number of likes a user has received</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        likes : int</span>
<span class="sd">            Number of total likes a user has received</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">likes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_posts_by_like_count</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">like_count</span> <span class="k">for</span> <span class="p">(</span><span class="n">shortcode</span><span class="p">,</span> <span class="n">like_count</span><span class="p">)</span> <span class="ow">in</span> <span class="n">likes</span><span class="p">])</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, CONCURRENT STUDIO

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>